name: Python 3.14t on windows-11-arm

on: [push]

jobs:
  test-python:
    runs-on: windows-11-arm

    steps:
      - uses: actions/checkout@v6

      - name: Check if Python 3.14t is already installed
        id: check
        shell: pwsh
        run: |
          $paths = @(
            "C:\hostedtoolcache\windows\Python\3.14.2\arm64-freethreaded",
            "C:\Python314t"
          )
          foreach ($p in $paths) {
            if (Test-Path "$p\python.exe") {
              Write-Host "found=$p" >> $env:GITHUB_OUTPUT
              exit 0
            }
          }
          Write-Host "found=" >> $env:GITHUB_OUTPUT

      - name: Install Python 3.14t manually
        shell: pwsh
        run: |
          $url = "https://github.com/actions/python-versions/releases/download/3.14.2-20014991423/python-3.14.2-win32-arm64-freethreaded.zip"
          
          $zip = "$env:USERPROFILE\python314t.zip"
          $dest = "C:\Python314t"

          Invoke-WebRequest -Uri $url -OutFile $zip

          # Use 7zip because PowerShell's extractor corrupts python.exe
          choco install 7zip -y
          7z x $zip -o"$dest" -y

          echo "$dest" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Add Python to PATH (if preinstalled)
        if: steps.check.outputs.found != ''
        shell: pwsh
        run: |
          echo "${{ steps.check.outputs.found }}" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Verify Python
        shell: pwsh
        run: |
          python --version
          python -c "import sys; print(sys._is_gil_enabled())"
