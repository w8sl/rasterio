name: Python 3.14t on windows-11-arm

on: [push]

jobs:
  test-python:
    runs-on: windows-11-arm

    steps:
      - uses: actions/checkout@v6

      - name: Locate or install Python 3.14t
        id: python
        shell: pwsh
        run: |
          # Candidate locations for preinstalled Python 3.14t
          $candidates = @(
            "C:\hostedtoolcache\windows\Python\3.14.2\arm64-freethreaded",
            "C:\Python314t"
          )

          foreach ($p in $candidates) {
            if (Test-Path "$p\python.exe") {
              Write-Host "path=$p" >> $env:GITHUB_OUTPUT
              exit 0
            }
          }

          # Not found â€” install Python 3.14t silently
          $url = "https://www.python.org/ftp/python/3.14.2/python-3.14.2-arm64.exe"
          $installer = "$env:USERPROFILE\python314t-installer.exe"
          $target = "C:\Python314t"

          Invoke-WebRequest -Uri $url -OutFile $installer

          # Silent install, all users, prepend PATH automatically
          & $installer /quiet InstallAllUsers=1 PrependPath=1 TargetDir="$target"

          Write-Host "path=$target" >> $env:GITHUB_OUTPUT

      - name: Add Python 3.14t to PATH (ensure override)
        shell: pwsh
        run: |
          $py = "${{ steps.python.outputs.path }}"
          Set-Content -Path $env:GITHUB_PATH -Value $py -Encoding ascii

      - name: Verify Python 3.14t
        shell: pwsh
        run: |
          python --version
          Get-Command python | Format-List *
          python -c "import sys; print(sys._is_gil_enabled())"
